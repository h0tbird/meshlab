{
	"name": "meshlab",
	"build": {
		"dockerfile": "Dockerfile",
		"options": [
			"--tag", "ghcr.io/h0tbird/meshlab/devcontainer:latest"
		]
	},
	"initializeCommand": {
		"lazy-load-ssh-keys": "ssh -T git@github.com || true",
		"create-istio-dir": "mkdir -p ${localWorkspaceFolder}/../istio"
	},
	"mounts": [
		"type=bind,source=/run/host-services/ssh-auth.sock,target=/ssh-agent",
		"type=bind,source=${localEnv:HOME}/.kube/config,target=/root/.kube/config",
		"type=bind,source=${localWorkspaceFolder}/../istio,target=/workspaces/istio",
		"type=bind,source=/var/run/docker.sock,target=/var/run/docker-host.sock"

	],
	"features": {
		"ghcr.io/devcontainers/features/docker-in-docker:2": {},
		"ghcr.io/devcontainers/features/sshd:1": {
			"version": "latest"
		}
	},
	"remoteEnv": {
		"LOCAL_WORKSPACE_FOLDER": "${localWorkspaceFolder}"
	},
	"containerEnv": {
		"GITHUB_TOKEN": "${localEnv:GITHUB_TOKEN}",
		"GITHUB_USER": "${localEnv:GITHUB_USER}",
		"DOCKER_HOST": "unix:///var/run/docker-host.sock"
	},
	"remoteUser": "root",
	"runArgs": [
		"--name", "meshlab",
		"--network", "host",
		"--privileged"
	],
	"forwardPorts": [8080, 8081, 8082, 8083, 8084, 8085, 9091, 9092],
	"portsAttributes": {
		"8080": {
			"label": "argocd",
			"onAutoForward": "notify",
			"protocol": "http"
		},
		"8081": {
			"label": "argowf",
			"onAutoForward": "notify",
			"protocol": "http"
		},
		"8082": {
			"label": "vault",
			"onAutoForward": "notify",
			"protocol": "http"
		},
		"8083": {
			"label": "prometheus",
			"onAutoForward": "notify",
			"protocol": "http"
		},
		"8084": {
			"label": "grafana",
			"onAutoForward": "notify",
			"protocol": "http"
		},
		"8085": {
			"label": "kiali",
			"onAutoForward": "notify",
			"protocol": "http"
		},
		"9091": {
			"label": "tilt-pasta-1",
			"onAutoForward": "notify",
			"protocol": "http"
		},
		"9092": {
			"label": "tilt-pasta-2",
			"onAutoForward": "notify",
			"protocol": "http"
		}
	},
	"otherPortsAttributes": {
		"onAutoForward" : "ignore"
	},
	"customizations": {
		"vscode": {
			"settings": {
				"remote.autoForwardPorts":false
			},
			"extensions": [
				"github.copilot",
				"github.copilot-chat",
				"github.vscode-pull-request-github",
				"ms-azuretools.vscode-docker",
				"timonwong.shellcheck",
				"shardulm94.trailing-spaces",
				"tilt-dev.tiltfile"
			]
		}
	},
	"hostRequirements": {
		"cpus": 8,
		"memory": "16gb"
	},
	"postCreateCommand": {
		"clone-istio": "test -d /workspaces/istio/.git || { gh repo clone h0tbird/forked-istio /workspaces/istio && cd /workspaces/istio && git remote add upstream https://github.com/istio/istio.git; }"
	}
}
