#!/usr/bin/env bash

# shellcheck source=/dev/null
source lib/common.sh

#------------------------------------------------------------------------------
# Delete clusters
#------------------------------------------------------------------------------

multipass suspend $(list clusters all)
# multipass delete $(list clusters all)
# multipass purge

#------------------------------------------------------------------------------
# Setup KUBECONFIG
#------------------------------------------------------------------------------

for CLUSTER in $(list clusters all); do
  kubectl config delete-user "${CLUSTER}"
  kubectl config delete-cluster "${CLUSTER}"
  kubectl config delete-context "${CLUSTER}"
done

#------------------------------------------------------------------------------
# Delete ArgoCD context
#------------------------------------------------------------------------------

argocd context --delete "${MNGR}"

#------------------------------------------------------------------------------
# Delete the istio-sidecar.deb
#------------------------------------------------------------------------------

rm -f ./tmp/virt-01/istio-sidecar.deb || true

#------------------------------------------------------------------------------
# Flush the IP address pool
#------------------------------------------------------------------------------

sudo launchctl stop com.apple.bootpd
sudo rm -f /var/db/dhcpd_leases
sudo launchctl start com.apple.bootpd
