# This Dockerfile builds a debug version of Istio pilot-agent with Delve installed.
# It is based on the official istio/proxyv2 image and adds debug symbols along with the Delve debugger.
# The Go build steps were derived by observing the `DEBUG=1 make build` process
# in the main Istio repository, specifically the `go build` command emitted by:
#
#  GOOS=linux GOARCH=arm64 LDFLAGS='' VERBOSE=1 DEBUG=1 common/scripts/gobuild.sh \
#  /work/out/linux_arm64/ -tags=agent,disable_pgv,grpcnotrace,retrynotrace \
#  ./pilot/cmd/pilot-agent 2>&1 | grep '+ go build'
#
# This approach involves some creative interpretationâ€”use at your own risk.
#
# Build and deploy:
#   make pilot-agent
#   k --context kind-pasta-1 -n service-1 patch deploy/worker --type='merge' -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/proxyImage":"ghcr.io/h0tbird/proxyv2:1.28.2-patch.1"}}}}}'
#
# Debug:
#   k --context kind-pasta-1 -n service-1 exec -it deployment/worker -c istio-proxy -- dlv dap --listen=:40000 --log=true
#   k --context kind-pasta-1 -n service-1 port-forward deployment/worker 40000:40000

# Any ARG before the first FROM can be used in any FROM line
ARG BASE_IMAGE_TAG=latest

#------------------------------------------------------------------------------
# Buildtime
#------------------------------------------------------------------------------

FROM golang:1.25 AS builder

# Build arguments
ARG VERSION="unknown"
ARG REGISTRY="unknown"
ARG GIT_SHA="unknown"

# Cache dependencies
WORKDIR /workspace
COPY go.mod go.mod
COPY go.sum go.sum
RUN go mod download

# Copy the code
COPY pilot/ pilot/
COPY pkg/ pkg/
COPY operator/ operator/
COPY security/ security/
COPY tools/ tools/
COPY common/ common/

# Build
RUN go build -x -o pilot-agent \
  -gcflags=all="-N -l" -ldflags "-extldflags -static \
  -X istio.io/istio/pkg/version.buildVersion=${VERSION} \
  -X istio.io/istio/pkg/version.buildGitRevision=${GIT_SHA} \
  -X istio.io/istio/pkg/version.buildStatus=debug \
  -X istio.io/istio/pkg/version.buildTag=${VERSION} \
  -X istio.io/istio/pkg/version.buildHub=${REGISTRY} \
  -X istio.io/istio/pkg/version.buildOS=${TARGETOS} \
  -X istio.io/istio/pkg/version.buildArch=${TARGETARCH}" \
  -tags=agent,disable_pgv,grpcnotrace,retrynotrace \
  ./pilot/cmd/pilot-agent

# Install delve
RUN go install github.com/go-delve/delve/cmd/dlv@latest

#------------------------------------------------------------------------------
# Runtime
#------------------------------------------------------------------------------

FROM istio/proxyv2:${BASE_IMAGE_TAG}

# Copy binaries and source code
COPY --from=builder /go/bin/dlv /usr/local/bin/dlv
COPY --from=builder /workspace /workspace
COPY --from=builder /go /go
RUN mv /workspace/pilot-agent /usr/local/bin/

# # Use delve as launch command
# EXPOSE 40000
# ENTRYPOINT [ "/usr/local/bin/dlv", "exec", "/usr/local/bin/pilot-agent", "--headless", "--listen=:40000", "--api-version=2", "--accept-multiclient", "--" ]
